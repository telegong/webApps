<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Monaco Editor</title>
  <style> html, body { margin: 0; height: 100%; } #container { width: 100%; height: 100%; } </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
</head>
<body>
  <div id="container"></div>
  <script>
    let editor;

    function sendRequestSync() {
      try { if (window.opener && !window.opener.closed) window.opener.postMessage({ type: 'request-sync' }, '*'); } catch(e){}
    }

    // 재등록 트리거
    window.addEventListener('DOMContentLoaded', () => setTimeout(sendRequestSync, 50));
    window.addEventListener('focus', sendRequestSync);
    document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') sendRequestSync(); });
    const syncInterval = setInterval(sendRequestSync, 3000);

    window.addEventListener('message', (e) => {
      if (!e.data || !e.data.type) return;
      if (e.data.type === 'sync' && typeof e.data.text === 'string') {
        if (editor) editor.setValue(e.data.text);
      }
    });

    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      editor = monaco.editor.create(document.getElementById('container'), {
        value: '',
        language: 'markdown',
        theme: 'vs-dark',
        automaticLayout: true,
        experimentalEditContextEnabled: false // IME 문제 완화 가능
      });

      editor.onDidChangeModelContent(() => {
        const text = editor.getValue();
        try { window.opener.postMessage({ type: 'update', text }, '*'); } catch(e) {}
      });

      // 로드 직후 메인에 싱크 요청
      sendRequestSync();
    });

    window.addEventListener('beforeunload', () => clearInterval(syncInterval));
  </script>
</body>
</html>
